# User-Facing Services Stack
# Non-VPN services: Overseerr, Maintainerr, Pulse
# These services don't need VPN and can run independently

services:
  overseerr:
    image: lscr.io/linuxserver/overseerr
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - 5055:5055
    volumes:
      - /var/lib/homelab-media-configs/overseerr:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m
    networks:
      - media_network
    restart: unless-stopped

  maintainerr:
    image: ghcr.io/maintainerr/maintainerr:latest
    container_name: maintainerr
    restart: unless-stopped
    user: ${PUID}:${PGID}
    ports:
      - 6246:6246
    volumes:
      - /var/lib/homelab-media-configs/maintainerr:/opt/data
    environment:
      - TZ=${TZ_MAINTAINERR}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6246"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 1m
    networks:
      - media_network

  pulse:
    image: rcourtman/pulse:latest
    container_name: pulse
    restart: unless-stopped
    ports:
      - 7655:7655
    volumes:
      - pulse_data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7655 || exit 0"]
      interval: 1m
      timeout: 10s
      retries: 2
      start_period: 2m
    networks:
      - media_network

  filebrowser:
    image: filebrowser/filebrowser:s6
    container_name: filebrowser
    restart: unless-stopped
    ports:
      - 8181:80
    volumes:
      - /mnt/media:/srv
      - /var/lib/homelab-media-configs/filebrowser/database:/database
      - /var/lib/homelab-media-configs/filebrowser/config:/config
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - media_network

  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10
      - AUTOHEAL_START_PERIOD=0
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
      - AUTOHEAL_LOG_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - media_network

networks:
  media_network:
    driver: bridge

volumes:
  pulse_data:
