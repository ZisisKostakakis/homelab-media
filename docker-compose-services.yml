# User-Facing Services Stack
# Non-VPN services: Overseerr, Maintainerr, Filebrowser
# These services don't need VPN and can run independently

services:
  overseerr:
    image: lscr.io/linuxserver/overseerr
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - 5055:5055
    volumes:
      - /var/lib/homelab-media-configs/overseerr:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 1m
    networks:
      - media_network
    restart: unless-stopped

  maintainerr:
    image: ghcr.io/maintainerr/maintainerr:latest
    container_name: maintainerr
    restart: unless-stopped
    user: ${PUID}:${PGID}
    ports:
      - 6246:6246
    volumes:
      - /var/lib/homelab-media-configs/maintainerr:/opt/data
    environment:
      - TZ=${TZ_MAINTAINERR}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6246"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 1m
    networks:
      - media_network

  filebrowser:
    image: filebrowser/filebrowser:s6
    container_name: filebrowser
    restart: unless-stopped
    ports:
      - 8181:80
    volumes:
      - /mnt/media:/srv
      - /var/lib/homelab-media-configs/filebrowser/database:/database
      - /var/lib/homelab-media-configs/filebrowser/config:/config
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    labels:
      - "wud.watch=false"  # Exclude from WUD monitoring - s6 tag causes false positives
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - media_network

  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10
      - AUTOHEAL_START_PERIOD=0
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
      - AUTOHEAL_LOG_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - media_network

  gluetun-monitor:
    image: alpine:latest
    container_name: gluetun-monitor
    restart: unless-stopped
    command: /bin/sh -c "apk add --no-cache docker-cli curl && /scripts/gluetun-cascade-restart.sh"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts:/scripts:ro
      - .:/homelab:ro  # Mount project directory for stack-manage.sh
      - /var/lib/homelab-media-configs/gluetun-monitor:/config
    environment:
      - TZ=${TZ}
    networks:
      - media_network
    labels:
      - "autoheal.stop=true"  # Don't let autoheal interfere with monitor
    healthcheck:
      test: ["CMD", "pgrep", "-f", "gluetun-cascade-restart.sh"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s

  whatsupdocker:
    image: getwud/wud:latest
    container_name: wud
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 3000:3000
    environment:
      # Authentication - Set username and password for WUD UI
      - WUD_AUTH_BASIC_ADMIN_USER=admin
      - WUD_AUTH_BASIC_ADMIN_HASH=$$apr1$$7QvzazFL$$JnWdEd57ERE23fgEVa/Aj.
      # Update check schedule (daily at 6 AM)
      - WUD_WATCHER_LOCAL_CRON=0 6 * * *
      # Ntfy Trigger - Send notifications when container updates are available
      - WUD_TRIGGER_NTFY_HOMELAB_URL=https://ntfy.sh
      - WUD_TRIGGER_NTFY_HOMELAB_TOPIC=blaze-homelab-wud-docker-updates
      - WUD_TRIGGER_NTFY_HOMELAB_PRIORITY=3  # 1=min, 3=default, 5=max
      - WUD_TRIGGER_NTFY_HOMELAB_MODE=batch  # batch = one notification for all updates
      # Webhook Trigger - Automatically update containers via webhook
      - WUD_TRIGGER_WEBHOOK_AUTOUPDATE_URL=http://wud-webhook:8182
      - WUD_TRIGGER_WEBHOOK_AUTOUPDATE_METHOD=POST
      - WUD_TRIGGER_WEBHOOK_AUTOUPDATE_MODE=simple  # simple = trigger for each container
    healthcheck:
      test: curl --fail http://localhost:${WUD_SERVER_PORT:-3000}/health || exit 1
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - media_network

  wud-webhook:
    image: python:3.11-alpine
    container_name: wud-webhook
    restart: unless-stopped
    command: /bin/sh -c "apk add --no-cache docker-cli docker-cli-compose bash curl && python3 /scripts/wud-webhook-server.py"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts:/scripts:ro
      - .:/homelab:ro  # Mount project directory for stack-manage.sh
      - /var/lib/homelab-media-configs/wud-updates:/var/lib/homelab-media-configs/wud-updates
    environment:
      - TZ=${TZ}
    ports:
      - 8182:8182
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8182/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - media_network

  portainer:
    container_name: portainer
    image: portainer/portainer-ce:lts
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - 9443:9443
      - 8000:8000  # Remove if you do not intend to use Edge Agents

volumes:
  portainer_data:
    name: portainer_data

networks:
  default:
    name: portainer_network
  media_network:
    name: homelab_media_network
    driver: bridge
